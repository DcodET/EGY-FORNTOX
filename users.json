const express = require('express');
const path = require('path');
const fs = require('fs');
const app = express();
const PORT = 3000;

// Middleware
app.use(express.static(path.join(__dirname, '.')));
app.use(express.json());

// Routes

// ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, '1111.html'));
});

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
app.get('/api/users', (req, res) => {
    try {
        const usersData = fs.readFileSync(path.join(__dirname, 'users.json'), 'utf8');
        res.json(JSON.parse(usersData));
    } catch (error) {
        res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' });
    }
});

// Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯
app.post('/api/users', (req, res) => {
    try {
        const usersData = fs.readFileSync(path.join(__dirname, 'users.json'), 'utf8');
        let users = JSON.parse(usersData);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (users.some(u => u.username === req.body.username)) {
            return res.status(400).json({ error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„' });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const newUser = {
            ...req.body,
            createdAt: new Date().toISOString(),
            status: 'active'
        };
        users.push(newUser);

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        fs.writeFileSync(path.join(__dirname, 'users.json'), JSON.stringify(users, null, 2));
        res.status(201).json(newUser);
    } catch (error) {
        res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
    }
});

// ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
app.put('/api/users/:username', (req, res) => {
    try {
        const usersData = fs.readFileSync(path.join(__dirname, 'users.json'), 'utf8');
        let users = JSON.parse(usersData);

        const userIndex = users.findIndex(u => u.username === req.params.username);
        if (userIndex === -1) {
            return res.status(404).json({ error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        users[userIndex] = {
            ...users[userIndex],
            ...req.body,
            lastUpdated: new Date().toISOString()
        };

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        fs.writeFileSync(path.join(__dirname, 'users.json'), JSON.stringify(users, null, 2));
        res.json(users[userIndex]);
    } catch (error) {
        res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
    }
});

// Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
app.delete('/api/users/:username', (req, res) => {
    try {
        const usersData = fs.readFileSync(path.join(__dirname, 'users.json'), 'utf8');
        let users = JSON.parse(usersData);

        const userIndex = users.findIndex(u => u.username === req.params.username);
        if (userIndex === -1) {
            return res.status(404).json({ error: 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯' });
        }

        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø­Ø°ÙÙ‡
        users[userIndex].status = 'inactive';

        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        fs.writeFileSync(path.join(__dirname, 'users.json'), JSON.stringify(users, null, 2));
        res.json({ message: 'ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­' });
    } catch (error) {
        res.status(500).json({ error: 'Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' });
    }
});

// ØµÙØ­Ø© Ø§Ù„Ø®Ø·Ø£ 404
app.use((req, res) => {
    res.status(404).send(`
        <!DOCTYPE html>
        <html lang="ar" dir="rtl">
        <head>
            <meta charset="UTF-8">
            <title>Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</title>
            <style>
                body { font-family: Arial; text-align: center; padding: 50px; background: #f0f2f5; }
                h1 { color: #e74c3c; }
            </style>
        </head>
        <body>
            <h1>âŒ Ø§Ù„ØµÙØ­Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</h1>
            <p>Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡Ø§ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.</p>
            <a href="/">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        </body>
        </html>
    `);
});

// Ø¨Ø¯Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±
app.listen(PORT, () => {
    console.log('âœ… ToxiTrack Server Started!');
    console.log(`ğŸ“¡ Open: http://localhost:${PORT}`);
    console.log(`ğŸ“¡ Open: http://localhost:${PORT}/1111.html`);
    console.log('Press Ctrl+C to stop the server');
});